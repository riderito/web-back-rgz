{% extends 'base.html' %}

{% block title %}
‚Äî –ò–Ω–∏—Ü–∏–∞—Ç–∏–≤—ã
{% endblock %}

{% block js %}
<script>
    function showNotification(message, type) {
        const container = document.getElementById('notification-container');
        if (!container) return; // –ï—Å–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω, –Ω–µ –¥–µ–ª–∞–µ–º –Ω–∏—á–µ–≥–æ
        
        // –°–æ–∑–¥–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        const notification = document.createElement('div');
        notification.className = `notification ${type} show`;
        notification.innerHTML = `
            <span>${message}</span>
            <button onclick="this.parentElement.remove()">‚úñ</button>
        `;
        
        // –î–æ–±–∞–≤–ª—è–µ–º –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
        container.appendChild(notification);
        
        // –£–±–∏—Ä–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
        setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => notification.remove(), 500);
        }, 5000);
    }
    
    document.querySelectorAll('.vote-btn').forEach(button => {
        button.addEventListener('click', function () {
            const initiativeId = this.dataset.id;
            const voteType = this.dataset.type;
    
            fetch('/vote', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: initiativeId, vote: voteType })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const initiativeDiv = document.querySelector(`.initiative[data-id="${initiativeId}"]`);
                    
                    let message = '';
                    let type = '';

                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
                    if (data.vote_type === null) {
                        message = '–í—ã –æ—Ç–º–µ–Ω–∏–ª–∏ —Å–≤–æ–π –≥–æ–ª–æ—Å!';
                        type = 'info';
                    } else if (voteType === 'up') {
                        message = '–í—ã –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª–∏ –∑–∞!';
                        type = 'success';
                    } else if (voteType === 'down') {
                        message = '–í—ã –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª–∏ –ø—Ä–æ—Ç–∏–≤!';
                        type = 'error';
                    }

                    showNotification(message, type);
            
                    if (data.deleted) {
                        alert('–ò–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞ —É–¥–∞–ª–µ–Ω–∞ –∏–∑-–∑–∞ –Ω–∏–∑–∫–æ–≥–æ —Ä–µ–π—Ç–∏–Ω–≥–∞!');
                        if (initiativeDiv) initiativeDiv.remove();
                    } else if (data.updated_votes !== undefined) {
                        const votesSpan = document.getElementById(`votes-${initiativeId}`);
                        if (votesSpan) votesSpan.textContent = data.updated_votes;
            
                        if (initiativeDiv) {
                            const upButton = initiativeDiv.querySelector(`.vote-btn[data-type="up"]`);
                            const downButton = initiativeDiv.querySelector(`.vote-btn[data-type="down"]`);
            
                            if (data.vote_type === 'up') {
                                upButton?.classList.add('active-vote');
                                downButton?.classList.remove('active-vote');
                            } else if (data.vote_type === 'down') {
                                downButton?.classList.add('active-vote');
                                upButton?.classList.remove('active-vote');
                            } else {
                                upButton?.classList.remove('active-vote');
                                downButton?.classList.remove('active-vote');
                            }
                        }
                    }
                } else {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—Å—Ç –æ—à–∏–±–∫–∏ –¥–ª—è "–û—Ç–º–µ–Ω–∏—Ç–µ —Ç–µ–∫—É—â–∏–π –≥–æ–ª–æ—Å –ø–µ—Ä–µ–¥ –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º"
                    if (data.error === '–û—Ç–º–µ–Ω–∏—Ç–µ —Ç–µ–∫—É—â–∏–π –≥–æ–ª–æ—Å –ø–µ—Ä–µ–¥ –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º') {
                        showNotification(data.error, 'info'); // –¢–∏–ø info –¥–ª—è —Å–∏–Ω–µ–≥–æ —Ü–≤–µ—Ç–∞
                    } else {
                        showNotification(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–∏', 'error');
                    }
                }
            })            
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–ø—Ä–æ—Å–∞:', error);
                showNotification('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'error');
            });
        });
    });
    
    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.pofini').forEach(content => {
            const button = document.querySelector(`.toggle-btn[data-id="${content.id.split('-')[1]}"]`);
    
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –æ–±—Ä–µ–∑–∞–Ω –ª–∏ —Ç–µ–∫—Å—Ç
            if (content.scrollHeight > content.offsetHeight) {
                button.style.display = 'inline-block'; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
            }
    
            button.addEventListener('click', function () {
                const isCollapsed = content.classList.contains('collapsed');
    
                if (isCollapsed) {
                    // –†–∞—Å–∫—Ä—ã–≤–∞–µ–º —Ç–µ–∫—Å—Ç
                    content.style.maxHeight = content.scrollHeight + 'px'; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–æ—á–Ω—É—é –≤—ã—Å–æ—Ç—É
                    content.classList.remove('collapsed');
                    content.classList.add('expanded');
    
                    // –ü–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–µ—Ä–µ—Ö–æ–¥–∞ —É–±–∏—Ä–∞–µ–º max-height
                    content.addEventListener('transitionend', function onTransitionEnd() {
                        if (content.classList.contains('expanded')) {
                            content.style.maxHeight = 'none';
                            content.removeEventListener('transitionend', onTransitionEnd);
                        }
                    });
    
                    button.textContent = '–°–∫—Ä—ã—Ç—å';
                } else {
                    // –°–∫—Ä—ã–≤–∞–µ–º —Ç–µ–∫—Å—Ç
                    content.style.maxHeight = content.scrollHeight + 'px'; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â—É—é –≤—ã—Å–æ—Ç—É –¥–ª—è –ø–ª–∞–≤–Ω–æ—Å—Ç–∏
                    content.classList.remove('expanded');
                    content.classList.add('collapsed');
    
                    // –û–±–Ω–æ–≤–ª—è–µ–º max-height —á–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à–æ–π —Ç–∞–π–º–∞—É—Ç, —á—Ç–æ–±—ã –∞–Ω–∏–º–∞—Ü–∏—è —Å—Ä–∞–±–æ—Ç–∞–ª–∞
                    requestAnimationFrame(() => {
                        content.style.maxHeight = calcHeight(content) + 'px'; // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–æ 3 —Å—Ç—Ä–æ–∫
                    });
    
                    button.textContent = '–ü–æ–∫–∞–∑–∞—Ç—å –±–æ–ª—å—à–µ';
                }
            });
    
            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –≤—ã—Å–æ—Ç—ã 3 —Å—Ç—Ä–æ–∫
            function calcHeight(el) {
                const lineHeight = parseFloat(getComputedStyle(el).lineHeight);
                const clampLines = 3; // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫ –¥–ª—è –æ–±—Ä–µ–∑–∫–∏
                return lineHeight * clampLines;
            }
        });
    });
    window.addEventListener('load', () => {
        const preloader = document.getElementById('preloader');
    
        // –ñ–¥—ë–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏ –∫—Ä—É–≥–∞ (2 —Å–µ–∫—É–Ω–¥—ã)
        setTimeout(() => {
            preloader.classList.add('hidden');
    
            // –£–¥–∞–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç –∏–∑ DOM —á–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É
            setTimeout(() => {
                preloader.style.display = 'none';
            }, 500);
        }, 2000); // –í—Ä–µ–º—è —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é –∞–Ω–∏–º–∞—Ü–∏–∏ (2s)
    });
</script>
{% endblock %} 

{% block content %}
<h1>–ò–Ω–∏—Ü–∏–∞—Ç–∏–≤—ã</h1>

{% if session.get('user_id') %}
    <div style="text-align: center; margin-bottom: 2.7rem;">
        <button class="home-page__button" onclick="location.href='{{ url_for('add_initiative') }}'">–°–æ–∑–¥–∞–π —Å–≤–æ—é –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—É</button>
    </div>
{% endif %}

{% if initiatives %}
<div class="sorting-links">
    <a href="{{ url_for('start', sort='newest') }}">–°–∞–º—ã–µ –Ω–æ–≤—ã–µ</a> |
    <a href="{{ url_for('start', sort='oldest') }}">–°–∞–º—ã–µ —Å—Ç–∞—Ä—ã–µ</a> |
    <a href="{{ url_for('start', sort='votes_high') }}">–ë–æ–ª—å—à–µ –≤—Å–µ–≥–æ –≥–æ–ª–æ—Å–æ–≤</a> |
    <a href="{{ url_for('start', sort='votes_low') }}">–ú–µ–Ω—å—à–µ –≤—Å–µ–≥–æ –≥–æ–ª–æ—Å–æ–≤</a>
</div>

<div class="initiatives">
    {% for initiative in initiatives %}
    <div class="initiative" data-id="{{ initiative['id'] }}">
        <div style="display: flex; align-items: center; gap: 1rem;">
            <h1 style="font-size: 2rem; flex-shrink: 0; margin: 0;">{{ initiative['number'] }}</h1>
            <h2 style="margin: 0;">{{ initiative['title'] }}</h2>
        </div>
        <p class="pofini collapsed" id="content-{{ initiative['id'] }}">{{ initiative['content'] }}</p>
        <button class="toggle-btn" data-id="{{ initiative['id'] }}" style="display: none;">–ü–æ–∫–∞–∑–∞—Ç—å –±–æ–ª—å—à–µ</button>

        <div class="initiative-footer">
            <small>–î–∞—Ç–∞: {{ initiative['created_at'] }}</small>
            <p class="pofini">–ö–æ–ª-–≤–æ –≥–æ–ª–æ—Å–æ–≤: <span id="votes-{{ initiative['id'] }}">{{ initiative['votes'] }}</span></p>
            
            <div class="button-container">
                <!-- –ö–Ω–æ–ø–∫–∏ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è -->
                {% if session.get('user_id') %}
                    <button class="vote-btn {% if initiative['user_vote'] == 'up' %}active-vote{% endif %}" 
                            data-id="{{ initiative['id'] }}" data-type="up">
                        üëç
                    </button>
                    <button class="vote-btn {% if initiative['user_vote'] == 'down' %}active-vote{% endif %}" 
                            data-id="{{ initiative['id'] }}" data-type="down">
                        üëé
                    </button>
                {% endif %}
            
                <!-- –£–¥–∞–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ -->
                {% if session.get('is_admin') and session.get('user_id') != initiative.user_id %}
                    <form method="POST" action="{{ url_for('admin_delete_initiative', initiative_id=initiative.id) }}">
                        <button type="submit" class="delete-btn">–£–¥–∞–ª–∏—Ç—å</button>
                    </form>
                {% elif session.get('user_id') == initiative.user_id %}
                    <!-- –£–¥–∞–ª–µ–Ω–∏–µ –≤–ª–∞–¥–µ–ª—å—Ü–µ–º -->
                    <form method="POST" action="{{ url_for('delete_initiative', initiative_id=initiative.id) }}">
                        <button type="submit" class="delete-btn">–£–¥–∞–ª–∏—Ç—å</button>
                    </form>
                {% endif %}
            </div>
        </div>        
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
{% if page %}
<div class="pagination">
    {% if page > 1 %}
        <button onclick="location.href='{{ url_for('start', page=page-1) }}'">–ù–∞–∑–∞–¥</button>
    {% endif %}
    {% if has_next_page %}
        <button onclick="location.href='{{ url_for('start', page=page+1) }}'">–ï—â—ë</button>
    {% endif %}
</div>
{% endif %}

{% if not initiatives %}
    <p class="pofini" style="text-align: center; font-size: 1.1rem; margin-top: 2rem;">
        –ò–Ω–∏—Ü–∏–∞—Ç–∏–≤ –ø–æ–∫–∞ –Ω–µ—Ç. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º, –∫—Ç–æ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç —Å–≤–æ—é!
    </p>
{% endif %}
{% endblock %}


{% block style %}<link rel="stylesheet" href="{{ url_for('static', filename='start.css') }}">{% endblock %}
