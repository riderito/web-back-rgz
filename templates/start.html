{% extends 'base.html' %}

{% block js %}
<script>
    document.querySelectorAll('.vote-btn').forEach(button => {
        button.addEventListener('click', function () {
            const initiativeId = this.dataset.id;
            const voteType = this.dataset.type;
    
            fetch('/vote', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: initiativeId, vote: voteType })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const initiativeDiv = document.querySelector(`.initiative[data-id="${initiativeId}"]`);
                    
                    if (data.deleted) {
                        // –£–≤–µ–¥–æ–º–ª—è–µ–º –æ–± —É–¥–∞–ª–µ–Ω–∏–∏ –∏ —É–±–∏—Ä–∞–µ–º DOM-—ç–ª–µ–º–µ–Ω—Ç
                        alert('–ò–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞ —É–¥–∞–ª–µ–Ω–∞ –∏–∑-–∑–∞ –Ω–∏–∑–∫–æ–≥–æ —Ä–µ–π—Ç–∏–Ω–≥–∞!');
                        initiativeDiv.remove();
                    } else if (data.updated_votes !== undefined) {
                        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–æ–ª–æ—Å–æ–≤
                        const votesSpan = document.getElementById(`votes-${initiativeId}`);
                        votesSpan.textContent = data.updated_votes;
                    }
                } else {
                    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—à–∏–±–∫–∏
                    alert(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–∏');
                }
            })
            .catch(error => console.error('–û—à–∏–±–∫–∞:', error));
        });
    });      
</script>
{% endblock %} 

{% block content %}
<h1>–ò–Ω–∏—Ü–∏–∞—Ç–∏–≤—ã</h1>
<div class="initiatives">
    {% for initiative in initiatives %}
    <div class="initiative" data-id="{{ initiative['id'] }}">
        <h1>{{ initiative['number'] }}</h1>
        <h2>{{ initiative['title'] }}</h2>
        <p>{{ initiative['content'] }}</p>
        <small>–î–∞—Ç–∞: {{ initiative['created_at'] }}</small>
        <p>–¢–µ–∫—É—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–æ–ª–æ—Å–æ–≤: <span id="votes-{{ initiative['id'] }}">{{ initiative['votes'] }}</span></p>
        {% if session.get('login') %}
            <button class="vote-btn" data-id="{{ initiative['id'] }}" data-type="up">üëç</button>
            <button class="vote-btn" data-id="{{ initiative['id'] }}" data-type="down">üëé</button>
        {% endif %}
        {% if session.get('user_id') == initiative.user_id %}
            <form method="POST" action="{{ url_for('delete_initiative', initiative_id=initiative.id) }}">
                <button type="submit" style="color:red;">–£–¥–∞–ª–∏—Ç—å</button>
            </form>
        {% endif %}
        {% if session.get('is_admin') %}
            <form method="POST" action="{{ url_for('admin_delete_initiative', initiative_id=initiative.id) }}">
                <button type="submit" style="color:red;">–£–¥–∞–ª–∏—Ç—å –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—É</button>
            </form>
        {% endif %}
    </div>
    {% endfor %}
</div>

{% if page %}
<div class="pagination">
    {% if page > 1 %}
        <button onclick="location.href='{{ url_for('start', page=page-1) }}'">–ù–∞–∑–∞–¥</button>
    {% endif %}
    {% if has_next_page %}
        <button onclick="location.href='{{ url_for('start', page=page+1) }}'">–ï—â—ë</button>
    {% endif %}
</div>
{% endif %}

{% if not initiatives %}
    <p>–ò–Ω–∏—Ü–∏–∞—Ç–∏–≤ –ø–æ–∫–∞ –Ω–µ—Ç. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º, –∫—Ç–æ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç —Å–≤–æ—é!</p>
{% endif %}
{% endblock %}
