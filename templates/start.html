{% extends 'base.html' %}

{% block js %}
<script>
    document.querySelectorAll('.vote-btn').forEach(button => {
        button.addEventListener('click', function () {
            const initiativeId = this.dataset.id;
            const voteType = this.dataset.type;
    
            fetch('/vote', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: initiativeId, vote: voteType })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const initiativeDiv = document.querySelector(`.initiative[data-id="${initiativeId}"]`);
                    
                    if (data.deleted) {
                        // –£–≤–µ–¥–æ–º–ª—è–µ–º –æ–± —É–¥–∞–ª–µ–Ω–∏–∏ –∏ —É–±–∏—Ä–∞–µ–º DOM-—ç–ª–µ–º–µ–Ω—Ç
                        alert('–ò–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞ —É–¥–∞–ª–µ–Ω–∞ –∏–∑-–∑–∞ –Ω–∏–∑–∫–æ–≥–æ —Ä–µ–π—Ç–∏–Ω–≥–∞!');
                        initiativeDiv.remove();
                    } else if (data.updated_votes !== undefined) {
                        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–æ–ª–æ—Å–æ–≤
                        const votesSpan = document.getElementById(`votes-${initiativeId}`);
                        votesSpan.textContent = data.updated_votes;

                        // –û–±–Ω–æ–≤–ª—è–µ–º —Ü–≤–µ—Ç –∫–Ω–æ–ø–æ–∫ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–Ω–æ–≥–æ vote_type
                        const upButton = initiativeDiv.querySelector(`.vote-btn[data-type="up"]`);
                        const downButton = initiativeDiv.querySelector(`.vote-btn[data-type="down"]`);

                        if (data.vote_type === 'up') {
                            upButton.style.backgroundColor = 'black';
                            downButton.style.backgroundColor = 'inherit';
                        } else if (data.vote_type === 'down') {
                            upButton.style.backgroundColor = 'inherit';
                            downButton.style.backgroundColor = 'black';
                        } else {
                            // –ï—Å–ª–∏ –Ω–∏ –æ–¥–Ω–æ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –æ–±–∞ —Ü–≤–µ—Ç–∞
                            upButton.style.backgroundColor = 'inherit';
                            downButton.style.backgroundColor = 'inherit';
                        }
                    }
                } else {
                    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—à–∏–±–∫–∏
                    alert(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–∏');
                }
            })
            .catch(error => console.error('–û—à–∏–±–∫–∞:', error));
        });
    });      
</script>
{% endblock %} 

{% block content %}
<h1>–ò–Ω–∏—Ü–∏–∞—Ç–∏–≤—ã</h1>

{% if session.get('user_id') %}
<button onclick="location.href='{{ url_for('add_initiative') }}'">–°–æ–∑–¥–∞–π —Å–≤–æ—é –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—É</button>
{% endif %}

{% if initiatives %}
<div>
    <a href="{{ url_for('start', sort='newest') }}">–°–∞–º—ã–µ –Ω–æ–≤—ã–µ</a> |
    <a href="{{ url_for('start', sort='oldest') }}">–°–∞–º—ã–µ —Å—Ç–∞—Ä—ã–µ</a> |
    <a href="{{ url_for('start', sort='votes_high') }}">–ë–æ–ª—å—à–µ –≤—Å–µ–≥–æ –≥–æ–ª–æ—Å–æ–≤</a> |
    <a href="{{ url_for('start', sort='votes_low') }}">–ú–µ–Ω—å—à–µ –≤—Å–µ–≥–æ –≥–æ–ª–æ—Å–æ–≤</a>
</div>
<div class="initiatives">
    {% for initiative in initiatives %}
    <div class="initiative" data-id="{{ initiative['id'] }}">
        <h1>{{ initiative['number'] }}</h1>
        <h2>{{ initiative['title'] }}</h2>
        <p>{{ initiative['content'] }}</p>
        <small>–î–∞—Ç–∞: {{ initiative['created_at'] }}</small>
        <p>–¢–µ–∫—É—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–æ–ª–æ—Å–æ–≤: <span id="votes-{{ initiative['id'] }}">{{ initiative['votes'] }}</span></p>
        {% if session.get('user_id') %}
        <button class="vote-btn" data-id="{{ initiative['id'] }}" data-type="up"
                style="background-color: {% if initiative['user_vote'] == 'up' %}black{% else %}inherit{% endif %};">
            üëç
        </button>
        <button class="vote-btn" data-id="{{ initiative['id'] }}" data-type="down"
                style="background-color: {% if initiative['user_vote'] == 'down' %}black{% else %}inherit{% endif %};">
            üëé
        </button>
        {% endif %}
        {% if session.get('user_id') == initiative.user_id %}
            <form method="POST" action="{{ url_for('delete_initiative', initiative_id=initiative.id) }}">
                <button type="submit">–£–¥–∞–ª–∏—Ç—å</button>
            </form>
        {% endif %}
        {% if session.get('is_admin') %}
            <form method="POST" action="{{ url_for('admin_delete_initiative', initiative_id=initiative.id) }}">
                <button type="submit">–£–¥–∞–ª–∏—Ç—å –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—É</button>
            </form>
        {% endif %}
    </div>
    {% endfor %}
</div>
{% endif %}

{% if page %}
<div class="pagination">
    {% if page > 1 %}
        <button onclick="location.href='{{ url_for('start', page=page-1) }}'">–ù–∞–∑–∞–¥</button>
    {% endif %}
    {% if has_next_page %}
        <button onclick="location.href='{{ url_for('start', page=page+1) }}'">–ï—â—ë</button>
    {% endif %}
</div>
{% endif %}

{% if not initiatives %}
    <p>–ò–Ω–∏—Ü–∏–∞—Ç–∏–≤ –ø–æ–∫–∞ –Ω–µ—Ç. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º, –∫—Ç–æ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç —Å–≤–æ—é!</p>
{% endif %}
{% endblock %}
